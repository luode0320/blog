### 事务提交流程

在InnoDB中，事务提交（Commit）的流程大致如下：

1. **事务开始**：
    - 当一个事务开始时，InnoDB会记录事务开始的时间戳，并为事务分配一个事务ID（事务编号）、时间戳。
2. **事务执行**：
    - 事务执行期间，所有对数据的修改都会被记录在内存中的缓冲池（Buffer Pool）中。
    - 每当事务对数据进行修改时，InnoDB会记录该修改的撤销日志（Undo Log）信息。
    - 修改的同时，InnoDB还会记录对应的重做日志（Redo Log）信息。
3. **重做日志记录**：
    - 每次修改数据时，InnoDB会将该修改的重做日志记录写入内存中的重做日志缓冲区（Redo Log Buffer）。
    - 重做日志记录包含了如何重新执行（redo）这些修改的信息。
4. **撤销日志记录**：
    - 每次修改数据时，InnoDB会将该修改的撤销日志记录写入内存中的撤销日志缓冲区（Undo Log Buffer）。
    - 撤销日志记录包含了如何撤销（undo）这些修改的信息。
    - 撤销日志（Undo Log）**通常是在内存中维护的**，而不是像重做日志（Redo Log）那样写入磁盘文件。
    - InnoDB会**同时记录重做日志和撤销日志**到缓冲区
5. **事务提交**：
    - 当事务提交时，InnoDB会**将重做日志缓冲区中的数据同步到磁盘上**的重做日志文件（Redo Log File）中。
6. **事务提交标记**：
    - InnoDB会在内存中记录一个事务提交标记（Commit Mark），表示该事务已经被提交。
    - 事务的状态从“**未提交**”变为“**已提交但未同步**”（prepare阶段）, 相当于标记提交。
    - 这个标记包含了事务的ID以及其他相关信息。
7. **检查点和脏页刷新**：
    - InnoDB会周期性地执行检查点（Checkpoint），将**缓冲池**中的脏页（Dirty Pages, 被更改的数据）写入磁盘。
    - 在执行检查点时，InnoDB会**确保所有的重做日志都已经写入磁盘**。
    - 一旦脏页被写入磁盘，它们就不再是脏页。
8. **最终确认**：
    - 当所有相关的脏页都被写入磁盘后，事务的状态变为“**已提交并已同步**”（commit阶段）。

### 写入顺序和事务提交的顺序

为了确保事务的持久性（Durability），InnoDB需要按照以下顺序来写入和管理日志：

1. **重做日志 Redo Log 先写入**：
    - 在事务提交之前，InnoDB会先将重做日志记录写入内存中的**重做日志缓冲区**。
    - 然后，InnoDB会将重做日志缓冲区中的数据**同步到磁盘上的重做日志文件**中。
    - 这样可以确保即使在系统崩溃后，也能通过重做日志恢复数据的一致性。
2. **撤销日志在内存中记录**：
    - **撤销日志记录在内存中保存，直到事务需要回滚或事务结束后才会被清除或归档**。
    - 撤销日志主要用于事务回滚和多版本并发控制（MVCC）。
3. **事务提交标记记录**：
    - 在事务提交时，InnoDB会记录一个**事务提交标记**，表示事务已经提交。
    - 事务提交标记通常包含事务ID和其他相关信息，用于后续的恢复操作。

### 总结

- **重做日志（Redo Log）**：在事务提交之前，先将重做日志记录写入内存中的重做日志缓冲区，然后同步到磁盘上的重做日志文件中。这样做可以确保即使系统崩溃，也能通过重做日志恢复数据的一致性。
- **撤销日志（Undo Log）**：**撤销日志记录在内存中保存**，主要用于事务回滚和多版本并发控制。撤销日志记录在事务结束后才会被清除或归档。