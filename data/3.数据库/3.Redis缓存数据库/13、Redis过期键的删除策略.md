### Redis 过期键的删除策略

Redis 提供了几种不同的策略来处理过期键的删除，这些策略旨在确保数据的一致性和系统的性能。

### 1. **定时删除（Immediate Deletion）**

#### 描述

当一个键设置有过期时间时，Redis 会在键过期后**立即删除**它。

#### 优点

- **数据一致性**：过期键立即被删除，确保数据的一致性。
- **内存回收**：立即释放过期键占用的内存空间。

#### 缺点

- **性能开销**：每次键过期都需要执行删除操作，这可能会引入**额外的性能开销**。
- **不适合高频过期**：如果大量键频繁过期，这种策略可能会导致较高的性能开销。

### 2. **惰性删除（Lazy Deletion）**

#### 描述

当一个键过期时，Redis 不会立即删除它，而是在**真正访问该键时**才检查其过期时间，并进行**删除**。

#### 优点

- **减少性能开销**：只有在真正访问过期键时才会执行删除操作，**减少了不必要的性能开销**。
- **内存效率**：只有在访问过期键时才释放内存，避免了不必要的内存回收操作, 以空间换时间。

#### 缺点

- **内存占用**：过期键在被访问之前仍然**占用内存空间**。
- **影响主线程**: 检查是在访问的时候执行的, 主线程会增加检查的操作步骤。

### 3. **定期删除（Periodic Deletion）**

#### 描述

Redis 会**定期检查**数据库中的过期键，并删除它们。这种检查和删除操作是通过后台线程完成的，以减少对主线程的影响。

#### 优点

- **平衡性能和内存**：定期检查和删除过期键，在保证数据一致性和内存回收的同时，**减少了性能开销**。
- **减少主线程压力**：通过后台线程进行检查和删除操作，**减少对主线程的影响**。

#### 缺点

- **数据一致性**：过期键在定期检查期间仍然存在，可能导致数据的一致性问题。
- **配置灵活性**：需要合理配置定期检查的频率和数量，以达到最佳效果。

### Redis 的具体实现

在 Redis 中，**默认**过期键的删除策略实际上是结合了 **惰性删除** 和 **定期删除** 的混合策略。

#### 1. **惰性删除**

每当 Redis 访问一个键时，都会检查该键是否已过期。如果已过期，则立即删除。

#### 2. **定期删除**

Redis 会在后台周期性地检查过期键，并删除它们。这种检查和删除操作是通过定时任务完成的，具体实现如下：

- **定时任务**：Redis 会每隔一段时间（**默认为 100 毫秒**）执行一次定时任务。
- **检查数量**：在每次定时任务中，Redis 会检查固定数量的数据库（默认为 5个），并从中**随机抽取一批过期键检查后**进行删除（默认为
  20 个）。

### 配置选项

Redis 的过期键删除策略可以通过配置文件进行调整，以下是一些相关的配置选项：

#### `lazyfree-lazy-user-del`

此选项控制是否启用惰性删除模式下的用户删除操作。如果设置为 `yes`，则用户删除操作会被延迟执行。

#### `lazyfree-lazy-server-del`

此选项控制是否启用惰性删除模式下的服务器删除操作。如果设置为 `yes`，则服务器删除操作会被延迟执行。

### 示例配置

以下是一个示例配置，展示了如何调整 Redis 的过期键删除策略：

```sh
# Redis 配置文件示例
lazyfree-lazy-user-del yes
lazyfree-lazy-server-del yes
```

