### 哈希槽

Redis 哈希槽（Hash Slot）是 Redis 集群模式中的一个重要概念。

在 Redis 集群中，哈希槽用于将键分配到不同的节点上，以实现键值对的分布式存储。

理解哈希槽的工作原理对于合理设计和管理 Redis 集群至关重要。

### 哈希槽的基本概念

1. **总数**：
    - Redis 集群中总共有 16384 个哈希槽。
    - 每个哈希槽都是一个整数索引，范围从 0 到 16383。
2. **键分配**：
    - Redis 使用一种算法来计算每个键应该分配到哪个哈希槽。
    - 具体来说，Redis 对键的 CRC16 校验和取模运算，得到的结果决定了该键所在的哈希槽。
3. **节点映射**：
    - 每个哈希槽可以映射到集群中的一个节点上。
    - Redis 集群会将 16384 个哈希槽分配给集群中的各个节点，使得每个节点负责一部分哈希槽。

### 哈希槽的工作原理

1. **键的哈希计算**：
    - 对于每一个键，Redis 计算其 CRC16 校验和。
    - 计算结果取模 16384，得到一个介于 0 到 16383 之间的整数，即哈希槽索引。
2. **哈希槽分配**：
    - Redis 集群中的每个节点负责一部分哈希槽。
    - Redis 集群通过配置文件或动态调整来分配哈希槽到各个节点。
3. **键的定位**：
    - 当客户端发送请求时，Redis 客户端计算键对应的哈希槽索引。
    - 客户端根据哈希槽索引找到负责该哈希槽的节点，并将请求发送到该节点。

### Redis 集群中的节点角色

1. **主节点（Master）**：
    - 负责处理客户端请求。
    - 保持最新数据。
2. **从节点（Slave）**：
    - 负责数据复制，通常用于读操作。
    - 在主节点发生故障时，可以从节点提升为主节点。

### 哈希槽分配示例

假设你有一个 Redis 集群，包含 3 个主节点，每个主节点都有一个从节点，共 6 个节点。

#### 分配哈希槽

1. **哈希槽分配**：
    - 16384 个哈希槽平均分配到 3 个主节点上，每个主节点大约负责 5461 个哈希槽。
2. **示例分配**：
    - 假设主节点 A 负责哈希槽 0 至 5460。
    - 主节点 B 负责哈希槽 5461 至 10921。
    - 主节点 C 负责哈希槽 10922 至 16383。

#### 动态调整

如果集群中的某个节点发生故障，Redis 集群会自动重新分配受影响的哈希槽到其他健康的节点上，以保证数据的可用性和一致性。

### Redis 集群的命令限制

在 Redis 集群模式下，并非所有 Redis 命令都可以使用。以下是一些重要的限制：

1. **事务（MULTI/EXEC）**：
    - 在集群模式下，事务不能跨多个节点执行。
    - 如果一个事务涉及多个哈希槽，那么这个事务不能在一个请求中完成。
    - 每个节点只能处理属于它的哈希槽范围内的命令。
2. **Lua 脚本**：
    - Lua 脚本也不能跨多个哈希槽执行。
    - 如果脚本涉及多个哈希槽，那么脚本不能在一个请求中完成。
3. **排序（SORT）**：
    - SORT 命令不能跨多个哈希槽执行。
4. **发布订阅（PUBLISH/SUBSCRIBE）**：
    - 发布订阅功能不受哈希槽的限制，可以在集群中的任何节点上执行。
5. **Pipelining管道**:
    - 管道可以正常使用。

### Redis 集群的管理和监控

1. **Redis 集群信息**：
    - 可以使用 `CLUSTER NODES` 命令查看集群中的节点信息及其状态。
    - 使用 `INFO` 命令获取集群的状态信息。
2. **客户端工具**：
    - 使用 Redis 客户端工具（如 `redis-cli`）连接集群，并执行集群相关的命令。
    - 使用可视化工具（如 Redis Commander 或 RedisInsight）来管理集群。