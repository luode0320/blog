### 集群之间是如何复制的

在 Redis 集群中，主从复制（Replication）是在主节点（Master）和从节点（Slave）之间进行的, 这个复制的操作是异步的。

虽然 Redis 集群模式本身不支持节点间的直接复制（每个节点独立管理自己的数据分区），但从节点可以配置为某个主节点的从节点，从而实现数据的同步。

### Redis 主从复制机制

Redis 主从复制机制是通过以下步骤实现的：

1. **初次复制（Full Resynchronization）**：

    - 当一个从节点第一次连接到主节点时，它会请求完整的数据集。
    - 主节点会将当前内存中的所有数据（RDB 文件的形式）发送给从节点。
    - 从节点会清空当前的数据，并加载主节点发送的数据。
    - 在数据传输过程中，主节点会继续接收客户端的写命令，并将这些命令暂存到 `replica backlog buffer` 中。
    - 主节点在完成 RDB 快照的发送传输完成后，会立即将暂存的命令发送给从节点。


2. **增量复制（Partial Resynchronization）**：

    - 在初次复制之后，**从节点会继续监听主节点的写操作**。
    - **从节点会主动请求主节点**发送 `replica backlog buffer` 中的命令
    - 主节点每次执行写操作时，都会将这些命令记录在 `replica backlog buffer` 中。
    - 如果从节点 `offset` 偏移量也在主节点的 `replica backlog buffer` 范围内，主节点就会发送命令给从节点。
    - 从节点接收到写命令后，会立即在本地执行相同的操作，以保持数据的一致性。
    - 如果从节点与主节点的连接断开，当重新连接时，从节点会请求主节点发送 `replica backlog buffer` 中的命令，而不是重新进行初次复制。

### 复制过程中的注意事项

1. **网络延迟**：
    - 确保主节点与从节点之间的网络延迟尽可能低，以减少数据同步的延迟。
2. **缓冲区大小**：
    - 通过配置 `repl-backlog-size` 来调整 `replica backlog buffer` 的大小，以适应不同的网络环境和数据量。
3. **从节点的负载**：
    - 确保从节点有足够的资源来处理复制命令，以避免从节点成为瓶颈。

