### 节点在什么上面运行智能合约代码

EVM - 以太坊虚拟机。 EVM遵循EVM规范，该规范是以太坊协议的组成部分。 EVM只是节点上的一个进程。

EVM 是一种沙箱环境，它为智能合约提供了一个隔离的执行环境，确保智能合约可以在各个节点上一致地执行，并且不会对系统造成危害。

### Ethereum 虚拟机（EVM）

EVM 是 Ethereum 网络的核心组件之一，它具有以下几个特点：

1. **隔离性**：
    - EVM 提供了一个隔离的环境，智能合约在这个环境中执行，不**会干扰到主机系统的其他部分**。
    - 这样可以确保智能合约的安全性，并**防止潜在的恶意代码对系统造成损害**。
2. **一致性**：
    - 所有参与 Ethereum 网络的节点都会运行 EVM，**确保智能合约在不同节点上执行的结果是一致的**。
    - 这种一致性是通过 EVM 的规范和设计来实现的，确保智能合约在任何地方执行的结果都是相同的。
3. **确定性**：
    - EVM 的执行是确定性的，这意味着**每次执行同一段智能合约代码都会得到相同的结果**，除非外部状态有所改变。
    - 这种特性对于区块链网络至关重要，因为它确保了智能合约的行为是**可以预测和验证的**。
4. **资源限制**：
    - EVM **通过 Gas 机制来限制智能合约执行的资源消耗**，防止无限循环和其他可能导致资源耗尽的问题。
    - Gas 机制确保了智能合约执行的每一个步骤都有明确的成本，并且当 Gas 用尽时，执行会自动停止。

### EVM 的组成

EVM 由以下几个主要部分组成：

1. **状态转换**：
    - 每次执行智能合约时，EVM 会根据合约代码和当前状态来执行一系列状态转换。
    - 这些状态转换包括读写存储、发送消息、创建新合约等操作。
2. **操作码（Opcode）**：
    - EVM 支持一系列预定义的操作码，每个操作码对应一个特定的功能，如算术运算、内存操作、控制流等。
    - 智能合约代码编译成 EVM 字节码后，由这些操作码组成的字节码会在 EVM 中执行。
3. **内存模型**：
    - EVM 提供了内存模型，包括堆栈（Stack）、内存（Memory）和存储（Storage）。
    - 堆栈用于临时存储数据，内存用于存储更大的数据结构，存储则用于持久保存数据。

### 智能合约的执行过程

1. **交易发送**：
    - 当用户发送一个交易来调用智能合约的方法时，交易包含调用的数据和 Gas Limit。
2. **交易打包**：
    - 在 PoS 机制下，验证者通过一个随机选择的过程来决定谁是下一个提议者。
    - 一旦某个验证者被选为提议者，它就会开始收集未被打包的交易，并将它们打包进一个新的区块。
3. **执行智能合约**：
    - 提议者在 EVM 上执行智能合约代码。
    - 每个操作都会消耗一定的 Gas，并更新区块链的状态。
    - 在 PoS 机制下，**智能合约的执行只在一个提议者节点上进行一次**。
        - 这是因为提议者负责创建新区块，并执行区块中的所有交易。
        - 其他验证者不需要重新执行智能合约，他们的任务是验证提议者创建的区块是否正确。
4. **状态更新**：
    - 智能合约执行完成后，提议者会更新区块链的状态，包括账户余额、合约存储等。
    - 提议者创建一个新区块，并广播给网络中的其他验证者。
5. **交易确认**：
    - 其他验证者收到新区块后，会验证区块的合法性。
    - 包括但不限于：
        - 验证区块头的信息是否正确（如哈希值、时间戳等）。
        - 验证区块中的交易是否有效（如签名、Gas 用量等）。
        - 验证区块的状态根是否正确（即区块内的状态转换是否符合规则）。
    - 验证者不需要重新执行智能合约来验证区块，他们只需要验证区块的合法性以及状态根是否正确。
    - 状态根是一个加密散列，它代表了区块执行后整个区块链的状态。如果状态根正确，那么验证者可以相信提议者已经正确执行了智能合约。
6. **达成共识**：
    - 如果其他验证者认为新区块是有效的，他们会在这个区块的基础上继续构建新的区块。
    - 如果发现有问题，验证者们会拒绝该区块，并等待下一个提议者提出新区块。