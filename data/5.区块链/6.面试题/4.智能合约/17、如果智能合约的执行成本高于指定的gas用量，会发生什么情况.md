### 如果智能合约的执行成本高于指定的gas用量，会发生什么情况

如果智能合约的执行成本高于您在交易中指定的 Gas Limit，**交易将会失败**，并且**回滚（revert）到执行前的状态**。

这种情况通常被称为“Gas 用尽”（Out of Gas）。

### 交易失败和回滚

1. **Gas Limit 达到**：
    - 当交易执行过程中消耗的 Gas 达到了您设置的 Gas Limit，EVM 会停止进一步执行交易。
    - 此时，**交易被视为失败，任何已经发生的中间状态更改都将被撤销**。
2. **交易回滚**：
    - 交易回滚意味着所有由该交易引发的中间状态更改将被撤销，就好像**交易从未发生一样**。
    - 例如，如果智能合约在执行过程中进行了状态更改（如更新账户余额或存储变量），这些更改将被撤销。
3. **状态恢复**：
    - 由于交易失败，区块链的状态将恢复到交易执行之前的版本。
    - 这种机制**确保了交易要么完全成功，要么完全失败**，从而保持了区块链的一致性和完整性。

### 费用计算

1. **实际费用**：
    - 即使交易失败，**已经消耗的 Gas 依然会产生费用**。
    - **实际费用为 Gas Used 乘以 Gas Price**。
2. **退款**：
    - 如果有剩余的 Gas，剩余的 Gas 会被退还。
    - 但是，**如果交易因为 Gas 用尽而失败，实际消耗的 Gas 依然会被扣费**。

### 总结

如果智能合约的执行成本高于您在交易中指定的 Gas Limit，交易将会失败，并且回滚到执行前的状态。

虽然交易本身会失败，但是已经消耗的 Gas 依然会产生费用。

为了避免这种情况，建议在发送交易之前使用 `estimateGas` 方法来估算所需的 Gas 用量，并设置一个合理的 Gas Limit。

这样可以确保交易顺利执行，并避免不必要的费用损失。