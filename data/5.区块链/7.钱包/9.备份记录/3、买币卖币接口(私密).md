# 3、买币卖币接口(私密)



# API官网

[官网](https://dev.moonpay.com/reference/get_v1-transactions)



# 验证签名

[验证签名官网](https://dev.moonpay.com/reference/reference-webhooks-signature)

MoonPay 会对**我们发送到您**的端点的 webhook 事件和请求进行签名。MoonPay 通过在每个事件的标头中包含签名来实现这一点。

这**允许您验证**事件和请求是由 MoonPay 发送的，而不是由第三方发送的。

MoonPay 使用基于哈希的消息认证码 [HMAC](https://en.wikipedia.org/wiki/HMAC) (一个密钥) 和 [SHA-256](https://en.wikipedia.org/wiki/SHA-2) 算法生成的签名 -> `HMAC-SHA256(key, message)`

- `Moonpay-Signature-V2`标头包含一个时间戳和一个签名。时间戳以t=为前缀，签名以s=为前缀。

  ```
  Moonpay-Signature-V2: t=1492774577,s=5257a869e7ecebeda32affa62cdca3fa51cad7e77a0e56ff536d0ce8e108d8bd
  ```

- 签名s字符串格式：`时间戳.请求体`

  - `POST` 请求通常会携带一个 **请求体**（Body），包含了发送到服务器的数据。

    假设 `POST` 请求的时间戳是 `1492774577`，Body 是：

    ```json
    {
      "example": "data",
      "id": 123
    }	
    ```

    构造签名字符串是：

    ```
    "1492774577.{\"example\":\"data\",\"id\":123}"
    ```

  - `GET` 请求通常不包含请求体，而是通过 URL 的查询参数（Query String）传递数据。

    假设 `GET` 请求的时间戳是 `1492774577`，查询参数是：

    ```json
    ?externalCustomerId=adbb317d-cde9-4ebb-93a3-1b271812de06
    ```

    构造签名字符串：

    ```
    "1492774577.?externalCustomerId=adbb317d-cde9-4ebb-93a3-1b271812de06"
    ```

- 解析出的 **时间戳t** 和 **请求的实际负载**，用 `.` 连接通过 `HMAC-SHA256` 算法生成的签名 = 签名s

```java
    /**
     * 生成签名，用于验证请求
     * MoonPay 会对**我们发送到您**的端点的 webhook 事件和请求进行签名。MoonPay 通过在每个事件的标头中包含签名来实现这一点。
     * 这**允许您验证**事件和请求是由 MoonPay 发送的，而不是由第三方发送的。
     *
     * @param param 请求参数，包含 URL
     * @return 包含签名和跳转 URL 的 JSON 对象
     */
    @RequestMapping(value = "getSign", method = RequestMethod.POST, consumes = "application/json", produces = "application/json")
    public JSONObject getSign(@RequestBody Map<String, String> param) {
        // 对 URL 的查询参数部分(?Id=adbb317d)进行 HMAC SHA256 签名，并将结果进行 Base64 编码
        String queryParam = param.get("url").substring(param.get("url").indexOf("?"));
        byte[] sign = StringUtil.getHmacSHA256Bytes(queryParam, secretKey);
        String base64_EncryptedData = Base64.getEncoder().encodeToString(sign);

        // 构造返回结果
        JSONObject returnVal = new JSONObject();
        returnVal.put("signature", URLEncoder.encode(base64_EncryptedData));
        returnVal.put("jumpUrl", param.get("url") + "&signature=" + returnVal.getString("signature"));
        return returnVal;
    }
```



# 购买

## 列出购买交易

[参数响应看官网](https://dev.moonpay.com/reference/get_v1-transactions)

返回满足查询参数中提供的条件的成功购买交易数组。数组中的每个条目都是一个单独的交易对象。交易将按从最新到最旧的方式列出。

```
get
https://api.moonpay.com/v1/transactions
```

```sh
curl --request GET \
     --url 'https://api.moonpay.com/v1/transactions?externalTransactionId=123&customerId=123&externalCustomerId=123&startDate=2023-07-01&endDate=2023-07-31&limit=20&offset=1' \
     --header 'Authorization: 123' \
     --header 'accept: application/json'
```



## 获取加密货币限额

[参数响应看官网](https://dev.moonpay.com/reference/getcurrencylimits)

返回包含最小和最大购买金额（包括或不包括基础货币和报价货币的费用）的对象。

如果提供了付款方式，它会考虑该付款方式，**否则它会默认采用费用最低的付款方式。**

**注意：**我们的货币最低限额有时会受到 LP 最低限额和市场总体波动等外部因素的影响而波动。

```
get
https://api.moonpay.com/v3/currencies/{currencyCode}/limits
```

```sh
curl --request GET \
     --url 'https://api.moonpay.com/v3/currencies/eth/limits?baseCurrencyCode=usd&paymentMethod=paypal&areFeesIncluded=true&apiKey=123' \
     --header 'accept: application/json'
```



## 获取加密网络费用

[参数响应看官网](https://dev.moonpay.com/reference/getnetworkfees)

返回一组键值对，表示加密货币相对于法定货币的当前网络费用。

提供您感兴趣的加密货币和法定货币的代码，MoonPay 将返回相关的网络费用。

```
get
https://api.moonpay.com/v3/currencies/network_fees
```

```sh
curl --request GET \
     --url 'https://api.moonpay.com/v3/currencies/network_fees?cryptoCurrencies=eth%2Cbtc&fiatCurrencies=usd%2Cgbp&apiKey=123' \
     --header 'accept: application/json'
```



## 获取实时购买报价

[参数响应看官网](https://dev.moonpay.com/reference/getbuyquote)	

根据提供的货币代码、基本金额、额外费用百分比、付款方式和费用包含获取详细的实时报价。

```
get
https://api.moonpay.com/v3/currencies/{currencyCode}/buy_quote
```

```sh
curl --request GET \
     --url 'https://api.moonpay.com/v3/currencies/eth/buy_quote?baseCurrencyCode=usd&quoteCurrencyAmount=3&baseCurrencyAmount=200&extraFeePercentage=1&paymentMethod=paypal&areFeesIncluded=true&apiKey=123' \
     --header 'accept: application/json'
     
# 测试
curl --request GET \
     --url 'https://api.moonpay.com/v3/currencies/btc/buy_quote?baseCurrencyCode=usd&baseCurrencyAmount=100&apiKey=pk_live_SGCdGCsO4JCl8YaMTMzCaYFLdiedTNS' \
     --header 'accept: application/json'
```



## 获取购买交易

[参数响应看官网](https://dev.moonpay.com/reference/getbuytransaction)

通过 ID 检索交易。如果不存在具有所提供标识符的交易，此调用将返回错误。

```
get
https://api.moonpay.com/v1/transactions/{transactionId}
```

```sh
curl --request GET \
     --url 'https://api.moonpay.com/v1/transactions/a617e457-7ea6-4e29-9415-0be500d478cf?apiKey=123' \
     --header 'accept: application/json'
```



## 通过外部标识符获取购买交易

[参数响应看官网](https://dev.moonpay.com/reference/getbuytransactionbyexternalid)

通过 externalTransactionId 检索交易。这是您在创建交易时为其分配的标识符。

此端点返回一个对象数组，因为我们无法确保 externalTransactionId 的唯一性。

```
get
https://api.moonpay.com/v1/transactions/ext/{externalTransactionId}
```

```sh
curl --request GET \
     --url 'https://api.moonpay.com/v1/transactions/ext/d228e63d-627e-4e3c-8dfb-b916a8950ff0?apiKey=123' \
     --header 'accept: application/json'
```





# 卖出

## 列出卖出交易

[参数响应看官网](https://dev.moonpay.com/reference/get_v3-sell-transactions)

返回满足查询参数中提供的条件的成功卖出交易数组。

数组中的每个条目都是一个单独的交易对象。交易将按从最新到最旧的方式列出。如果查询参数中未提供，此调用将返回错误。

```
get
https://api.moonpay.com/v3/sell_transactions
```

```sh
curl --request GET \
     --url 'https://api.moonpay.com/v3/sell_transactions?externalTransactionId=123&customerId=123&externalCustomerId=123&startDate=2023-07-01&endDate=2023-07-31&limit=20&offset=1' \
     --header 'Authorization: 123' \
     --header 'accept: application/json'
```

## 取消卖出交易

[参数响应看官网](https://dev.moonpay.com/reference/delete_v3-sell-transactions-transactionid)

取消销售交易。如果销售交易已成功取消，此端点将返回 HTTP 状态204 无内容。

如果销售交易无法取消（例如因为交易已完成），它将返回 HTTP 状态409 冲突。

```
delete
https://api.moonpay.com/v3/sell_transactions/{transactionId}
```

```sh
curl --request DELETE \
     --url https://api.moonpay.com/v3/sell_transactions/123 \
     --header 'Authorization: 123' \
     --header 'accept: application/json'
```

## 通过外部ID取消卖出交易

[参数响应看官网](https://dev.moonpay.com/reference/delete_v3-sell-transactions-ext-transactionid)

根据外部交易 ID 取消销售交易。如果销售交易已成功取消，此端点将返回 HTTP 状态204 无内容。

如果销售交易无法取消（例如因为交易已完成），它将返回 HTTP 状态409 冲突。

```
delete
https://api.moonpay.com/v3/sell_transactions/ext/{transactionId}
```

```sh
curl --request DELETE \
     --url https://api.moonpay.com/v3/sell_transactions/ext/transactionId/{交易id} \
     --header 'Authorization: pk_live_SGCdGCsO4JCl8YaMTMzCaYFLdiedTNS' \
     --header 'accept: application/json'
```

## 获取卖出报价

[参数响应看官网](https://dev.moonpay.com/reference/getsellquote)

返回一组表示货币实时卖出报价的键值对。

提供货币代码、基础金额、额外费用百分比、付款方式以及基础金额是否包含费用，MoonPay 将返回详细的卖出报价。

```
get
https://api.moonpay.com/v3/currencies/{currencyCode}/sell_quote
```

```sh
curl --request GET \
     --url 'https://api.moonpay.com/v3/currencies/eth/sell_quote?quoteCurrencyCode=usd&baseCurrencyAmount=3&extraFeePercentage=1&payoutMethod=paypal&apiKey=123' \
     --header 'accept: application/json'
```



## 获取卖出交易

[参数响应看官网](https://dev.moonpay.com/reference/getselltransaction)

根据 ID 检索销售交易。如果不存在具有所提供标识符的销售交易，此调用将返回错误。

```
get
https://api.moonpay.com/v3/sell_transactions/{transactionId}
```

```sh
curl --request GET \
     --url 'https://api.moonpay.com/v3/sell_transactions/dab3bdf4-e6ea-40a2-ad74-87536f9e8a7d?apiKey=123' \
     --header 'accept: application/json'
```



## 通过外部标识符获取销售交易

[参数响应看官网](https://dev.moonpay.com/reference/getselltransactionbyexternalid)

通过 externalTransactionId 检索交易。这是您在创建交易时为其分配的标识符。

此端点返回一个对象数组，因为我们无法确保 externalTransactionId 的唯一性。

```
get
https://api.moonpay.com/v3/sell_transactions/ext/{externalTransactionId}
```

```sh
curl --request GET \
     --url 'https://api.moonpay.com/v3/sell_transactions/ext/bc976ff6-c89d-4c35-9694-ae183758abf5?apiKey=123' \
     --header 'accept: application/json'
```

