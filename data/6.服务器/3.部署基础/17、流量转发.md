以下是基于 **IPSec VPN + 策略路由** 的企业级部署方案，分为 **香港服务器（服务端）** 和 **国内服务器（客户端）** 的详细配置步骤：

------

### **一、前置准备**

1. **服务器信息**

   - 香港服务器公网IP：`HK_IP`
   - 国内服务器公网IP：`CN_IP`
   - 内网网段规划：`10.10.0.0/24`（VPN专用）

2. **系统要求**

   - 确保两台服务器均已关闭防火墙或放行相关端口（UDP 500/4500，ESP协议）：

     ```sh
     # 香港和国内服务器均执行
     apt install -y ufw
     ufw allow 500/udp
     ufw allow 4500/udp
     ufw allow proto esp from any to any
     ```

------

### **二、香港服务器（IPSec服务端）配置**

#### 1. 安装StrongSwan（IPSec实现）

```sh
apt update
apt install -y strongswan strongswan-swanctl
```

#### 2. 生成预共享密钥（PSK）

```sh
# 生成随机密钥（记录到安全位置）, 等下要用两个服务器都要使用
openssl rand -base64 32
# 示例输出：yoursharedkey1234567890
```

#### 3. 配置IPSec (`/etc/ipsec.conf`)

```sh
vi /etc/ipsec.conf
```

```
config setup
    charondebug="ike 2, knl 2, cfg 2"
    uniqueids=never

conn %default
    ikelifetime=24h
    keylife=1h
    rekeymargin=3m
    keyingtries=1
    keyexchange=ikev2
    authby=secret
    ike=aes256-sha256-modp2048!
    esp=aes256-sha256-modp2048!
    mobike=no

conn cn-to-hk
    left=%any
    leftid=@hk-server
    leftsubnet=0.0.0.0/0
    leftfirewall=yes
    right=218.11.1.44
    rightid=@cn-client
    rightsubnet=10.10.0.2/32
    auto=add
```



#### 4. 配置PSK (`/etc/ipsec.secrets`)

```sh
vi /etc/ipsec.secrets
```

```
@hk-server @cn-client : PSK "59QGefmfDHNo+14J+95H/CGjvn0p4oYri6eNlGKk6U8="
```

**国内服务器和香港服务器的 `ipsec.secrets` 中的 PSK（预共享密钥）必须完全相同**



#### 5. 启用内核转发

```sh
vi /etc/sysctl.conf
```

```
net.ipv4.ip_forward=1
net.ipv4.conf.all.accept_redirects=0
net.ipv4.conf.all.send_redirects=0
```

```sh
sysctl -p
```



#### 6. 启动服务

```sh
root@CT128:~# systemctl list-unit-files | grep -i strongswan
strongswan-starter.service             enabled         enabled
```

```sh
systemctl start strongswan-starter
systemctl enable strongswan-starter
```



### **三、国内服务器（IPSec客户端）配置**

#### 1. 安装StrongSwan

```sh
apt update
apt install -y strongswan strongswan-swanctl
```

#### 2. 配置IPSec (`/etc/ipsec.conf`)

```sh
vi /etc/ipsec.conf
```

```
conn hk-to-cn
    left=%defaultroute
    leftid=@cn-client
    leftsubnet=10.10.0.2/32
    right=192.238.248.33
    rightid=@hk-server
    rightsubnet=0.0.0.0/0
    auto=start
```



#### 3. 配置PSK (`/etc/ipsec.secrets`)

```sh
vi /etc/ipsec.secrets
@cn-client @hk-server : PSK "59QGefmfDHNo+14J+95H/CGjvn0p4oYri6eNlGKk6U8="
```

**国内服务器和香港服务器的 `ipsec.secrets` 中的 PSK（预共享密钥）必须完全相同**



#### 4. 启动服务

```sh
root@CT128:~# systemctl list-unit-files | grep -i strongswan
strongswan-starter.service             enabled         enabled
```

```sh
systemctl start strongswan-starter
systemctl enable strongswan-starter
```

#### 5. 验证VPN连接

```sh
ipsec status
# 应显示 "ESTABLISHED" 状态
ping 192.238.248.33  # 测试与香港服务器的VPN连通性
```

------

### **四、策略路由配置（国内服务器）**

#### 1. 创建路由表

```sh
sudo nano /etc/iproute2/rt_tables
100    hk_route
```

#### 2. 添加策略路由规则

```sh
# 指定目标网站走VPN（示例：访问Google）
sudo ip route add 172.217.0.0/16 via 10.10.0.1 dev ipsec0 table hk_route

# 默认路由走本地网关
sudo ip rule add from all lookup main pref 32766
sudo ip rule add from all lookup default pref 32767

# 高优先级规则：目标为特定网站时走VPN
sudo ip rule add to 172.217.0.0/16 lookup hk_route pref 1000

# 持久化配置（Ubuntu/Debian）
sudo apt install netfilter-persistent iptables-persistent
sudo sh -c "echo 'post-up ip route flush cache' >> /etc/network/interfaces"
```

#### 3. 测试路由

```sh
# 检查路由路径
ip route get 172.217.1.1
# 应显示通过ipsec0设备转发

# 实际访问测试
curl --interface ipsec0 ifconfig.me  # 应返回香港IP
```

------

### **五、故障排查**

1. **VPN连接失败**

   ```sh
   sudo tail -f /var/log/syslog | grep charon
   # 检查IKE阶段错误
   ```

2. **路由不生效**

   ```sh
   ip rule list
   ip route show table hk_route
   traceroute -T 172.217.1.1
   ```

3. **性能优化**

   - 启用硬件加速（如有支持）：

     ```sh
     sudo apt install strongswan-mod-aesni
     ```

   - 调整MTU避免分片：

     ```sh
     sudo ifconfig ipsec0 mtu 1400
     ```

------

### **六、扩展建议**

1. 

   高可用方案

   

   - 部署多台香港服务器，使用`keepalived`实现VIP切换

2. 

   安全加固

   

   - 更换PSK为证书认证（`ipsec pki`生成证书）
   - 启用防火墙白名单：仅允许`CN_IP`访问UDP 500/4500

3. 

   流量监控

   

   - 使用`iftop -i ipsec0`实时监控VPN流量

通过以上配置，国内服务器的指定流量将通过IPSec VPN加密隧道经香港服务器转发，其他流量仍走本地网络。