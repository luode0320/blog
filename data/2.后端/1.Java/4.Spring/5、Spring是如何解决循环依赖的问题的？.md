# Spring是如何解决循环依赖的问题的？

循环依赖就是Bean的创建过程中,两个Bean创建过程相互依赖,导致Bean创建失败的问题

> 利用三级缓存解决循环依赖

**将实例化Bean和初始化Bean阶段得到的对象放在不同层级的缓存中**

- 一级缓存：保存所有已经`创建完成的bean`。
- 二级缓存：保存正常创建中的bean (`完成了实例化，但还未完成属性注入`)。
- 三级缓存：保存的是ObjectFactory类型的对象的工厂，通过工厂的方法可以获取到目标对象。

- `构造器实例化完成的对象`和`属性注入完成的Bean对象`区分开,放在不同的缓存中
- 利用Java是**值传递**的特性
- 创建A的过程中,先将B的半成品也就是**完成了实例化，但还未完成属性注入的对象赋值给A**
  - 过程中查找**一级缓存中没有**,然后去三级缓存中拿到对象工厂
  - 使用三级缓存的对象工厂**获取到仅仅完成实例化的Bean对象**,并`存入二级缓存`中
    - 如果这个对象与AOP的切点匹配,获取的对象将会是一个代理对象
  - 先完成A的Bean创建
  - A创建完成的Bean将存入一级缓存中,也就是最终的容器位置
- A创建完成之后,再将B的属性注入阶段完成
  - 之后也将B对象移到一级缓存
- 这样因为是**值传递的原因**,AB两个Bean的属性最终会`完成互相引用`
- 实现的重点是,必须要有**已经完成实例化的半成品Bean对象**
- 所以如果通过`构造函数引用`是没办法解决循环引用问题的